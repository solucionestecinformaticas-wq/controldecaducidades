<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Control de Caducidades</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome CDN -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <!-- React & ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Babel for JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- JsBarcode for barcode generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsbarcode/3.11.5/JsBarcode.all.min.js"></script>
  <!-- QuaggaJS for barcode scanning -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    body {
      font-family: 'Inter', sans-serif;
      min-height: 100vh;
      background-color: #f9fafb;
      color: #1f2937;
      transition: background-color 0.3s, color 0.3s;
    }
    .dark {
      background-color: #1a202c;
      color: #e5e7eb;
    }
    .dark .bg-white {
      background-color: #2d3748;
    }
    .dark .text-gray-800 {
      color: #e5e7eb;
    }
    .dark .text-gray-600 {
      color: #9ca3af;
    }
    .dark .border-gray-200 {
      border-color: #4b5563;
    }
    .scrollbar-custom {
      scrollbar-width: thin;
      scrollbar-color: #cbd5e1 #f1f5f9;
    }
    .scrollbar-custom::-webkit-scrollbar {
      width: 6px;
    }
    .scrollbar-custom::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 10px;
    }
    .scrollbar-custom::-webkit-scrollbar-thumb {
      background-color: #cbd5e1;
      border-radius: 10px;
    }
    .notification {
      position: fixed;
      top: 1rem;
      right: 1rem;
      padding: 1rem;
      background-color: #1f2937;
      color: white;
      border-radius: 0.5rem;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      transform: translateX(100%);
      animation: slideInNotification 0.3s ease-out forwards;
    }
    @keyframes slideInNotification {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    .stat-card {
      transition: all 0.3s ease;
    }
    .stat-card:hover {
      transform: translateY(-2px);
    }
    @media (max-width: 640px) {
      .floating-button {
        width: 3.5rem;
        height: 3.5rem;
        bottom: 1rem;
        right: 1rem;
      }
    }
    .status-fresh {
      background-color: #dcfce7;
      color: #166534;
      border: 1px solid #86efac;
    }
    .status-warning {
      background-color: #fef3c7;
      color: #92400e;
      border: 1px solid #fde68a;
    }
    .status-expired {
      background-color: #fee2e2;
      color: #991b1b;
      border: 1px solid #fca5a5;
    }
    .product-card {
      transition: all 0.3s ease;
      border: 1px solid #e5e7eb;
    }
    .product-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }
    .modal {
      transition: all 0.3s ease;
    }
    .fade-in {
      animation: fadeIn 0.3s ease-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .slide-in {
      animation: slideIn 0.3s ease-out;
    }
    @keyframes slideIn {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .toggle-checkbox:checked {
      right: 0;
      border-color: #68D391;
      transform: translateX(20px);
    }
    .toggle-checkbox:checked + .toggle-label {
      background-color: #68D391;
    }
    .toggle-label {
      transition: all 0.2s ease;
    }
    .category-slider {
      scrollbar-width: thin;
      -ms-overflow-style: none;
      max-height: 200px;
      overflow-y: auto;
    }
    .category-slider::-webkit-scrollbar {
      display: none;
    }
    .floating-button {
      width: 3.5rem;
      height: 3.5rem;
      background-color: #2563eb;
      color: white;
      border-radius: 9999px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      transition: all 0.2s ease;
      z-index: 10;
    }
    .floating-button:hover {
      background-color: #1d4ed8;
      transform: scale(1.1);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    .product-image {
      border-radius: 0.5rem;
      object-fit: cover;
      transition: transform 0.2s ease;
    }
    .product-image:hover {
      transform: scale(1.05);
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-gray-900 dark:text-gray-100 transition-colors duration-300">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef, useMemo } = React;

    // Database helper for IndexedDB
    const useIndexedDB = () => {
      const DB_NAME = 'ExpiryControlDB';
      const DB_VERSION = 1;
      const STORE_NAME = 'products';
      const CONFIG_STORE = 'config';

      const openDB = () => {
        return new Promise((resolve, reject) => {
          const request = indexedDB.open(DB_NAME, DB_VERSION);

          request.onerror = () => reject(request.error);
          request.onsuccess = () => resolve(request.result);

          request.onupgradeneeded = (event) => {
            const db = event.target.result;
            
            // Create products store if it doesn't exist
            if (!db.objectStoreNames.contains(STORE_NAME)) {
              const productStore = db.createObjectStore(STORE_NAME, { keyPath: 'id' });
              productStore.createIndex('name', 'name', { unique: false });
              productStore.createIndex('category', 'category', { unique: false });
              productStore.createIndex('expiryDate', 'expiryDate', { unique: false });
            }
            
            // Create config store if it doesn't exist
            if (!db.objectStoreNames.contains(CONFIG_STORE)) {
              db.createObjectStore(CONFIG_STORE, { keyPath: 'key' });
            }
          };
        });
      };

      const getProducts = async () => {
        try {
          const db = await openDB();
          return new Promise((resolve, reject) => {
            const transaction = db.transaction([STORE_NAME], 'readonly');
            const store = transaction.objectStore(STORE_NAME);
            const request = store.getAll();

            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
          });
        } catch (error) {
          console.error('Error getting products:', error);
          return [];
        }
      };

      const saveProducts = async (products) => {
        try {
          const db = await openDB();
          return new Promise((resolve, reject) => {
            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const store = transaction.objectStore(STORE_NAME);
            
            // Clear existing data
            store.clear();
            
            // Add new data
            if (Array.isArray(products) && products.length > 0) {
              products.forEach(product => {
                if (product.id) {
                  store.add(product);
                }
              });
            }

            transaction.oncomplete = () => resolve();
            transaction.onerror = () => reject(transaction.error);
          });
        } catch (error) {
          console.error('Error saving products:', error);
          throw error;
        }
      };

      const getConfig = async (key) => {
        try {
          const db = await openDB();
          return new Promise((resolve, reject) => {
            const transaction = db.transaction([CONFIG_STORE], 'readonly');
            const store = transaction.objectStore(CONFIG_STORE);
            const request = store.get(key);

            request.onsuccess = () => resolve(request.result ? request.result.value : null);
            request.onerror = () => reject(request.error);
          });
        } catch (error) {
          console.error('Error getting config:', error);
          return null;
        }
      };

      const saveConfig = async (key, value) => {
        try {
          const db = await openDB();
          return new Promise((resolve, reject) => {
            const transaction = db.transaction([CONFIG_STORE], 'readwrite');
            const store = transaction.objectStore(CONFIG_STORE);
            
            // Check if key exists
            const getRequest = store.get(key);
            
            getRequest.onsuccess = () => {
              if (getRequest.result) {
                // Update existing
                store.put({ key, value });
              } else {
                // Add new
                store.add({ key, value });
              }
            };

            transaction.oncomplete = () => resolve();
            transaction.onerror = () => reject(transaction.error);
          });
        } catch (error) {
          console.error('Error saving config:', error);
          throw error;
        }
      };

      return { getProducts, saveProducts, getConfig, saveConfig };
    };

    // Componente principal
    const App = () => {
      const db = useIndexedDB();
      
      // Estado principal
      const [darkMode, setDarkMode] = useState(false);
      const [products, setProducts] = useState([]);
      const [showModal, setShowModal] = useState(false);
      const [currentProduct, setCurrentProduct] = useState(null);
      const [searchTerm, setSearchTerm] = useState('');
      const [filterCategory, setFilterCategory] = useState('');
      const [categoryAlerts, setCategoryAlerts] = useState({});
      const [showSettings, setShowSettings] = useState(false);
      const [notification, setNotification] = useState(null);
      const [isLoading, setIsLoading] = useState(true);

      const fileInputRef = useRef(null);

      // Categorías predefinidas
      const categories = [
        '11054 CIGARROS',
        '11076 10A_TRACTO ALIMENTARIO Y METABOLISMO',
        '11076 10A_TRACTO ALIMENTARIO Y METABOLISMO (GESTOR)',
        '11077 10B_SANGRE Y APARATO HEMATOPOYETICO',
        '11077 10B_SANGRE Y APARATO HEMATOPOYETICO (GESTOR)',
        '11078 10C_SISTEMA CARDIOVASCULAR',
        '11078 10C_SISTEMA CARDIOVASCULAR (GESTOR)',
        '11079 10D_DERMATOLOGICOS',
        '11079 10D_DERMATOLOGICOS (GESTOR)',
        '11296 10E ESPECIALIZADOS',
        '11296 10E ESPECIALIZADOS (GESTOR)',
        '11080 10G_SIST GENITOURINARIO Y HORMONAS SEX',
        '11080 10G_SIST GENITOURINARIO Y HORMONAS SEX (GESTOR)',
        '11081 10H_PREP HORM SIST (EXCLUY HORMONAS SEX)',
        '11081 10H_PREP HORM SIST (EXCLUY HORMONAS SEX) (GESTOR)',
        '11082 10J_ANTIINFECCIOSOS SISTEMICOS GENERALES',
        '11082 10J_ANTIINFECCIOSOS SISTEMICOS GENERALES (GESTOR)',
        '11083 10K_SOLUCIONES HOSPITALARIAS',
        '11083 10K_SOLUCIONES HOSPITALARIAS (GESTOR)',
        '11084 10L_ANTINEOPLASICOS_Y_AGTS_INMUNOMODUL',
        '11084 10L_ANTINEOPLASICOS_Y_AGTS_INMUNOMODUL (GESTOR)',
        '11085 10M_SISTEMA_MUSCULO_ESQUELETICO',
        '11085 10M_SISTEMA_MUSCULO_ESQUELETICO (GESTOR)',
        '11086 10N_SISTEMA_NERVIOSO_CENTRAL',
        '11086 10N_SISTEMA_NERVIOSO_CENTRAL (GESTOR)',
        '11087 10P_PARASITOLOGIA',
        '11087 10P_PARASITOLOGIA (GESTOR)',
        '11088 10R_SISTEMA_RESPIRATORIO',
        '11088 10R_SISTEMA_RESPIRATORIO (GESTOR)',
        '11089 10S_ORGANOS_DE_LOS_SENTIDOS',
        '11089 10S_ORGANOS_DE_LOS_SENTIDOS (GESTOR)',
        '11090 10T_AGENTES_DE_DIAGNOSTICO',
        '11090 10T_AGENTES_DE_DIAGNOSTICO (GESTOR)',
        '11091 10V_VARIOS',
        '11091 10V_VARIOS (GESTOR)',
        '11092 10W_PRODUCTOS_NATURALES',
        '11092 10W_PRODUCTOS_NATURALES (GESTOR)',
        '11297 10Y_REFREGERADOS',
        '11297 10Y_REFREGERADOS (GESTOR)',
        '11298 10Z_CONTROLADOS',
        '11298 10Z_CONTROLADOS (GESTOR)',
        '11094 11A_RESPIRATORIOS_OTC',
        '11094 11A_RESPIRATORIOS_OTC (GESTOR)',
        '11095 11B_ANALGESICOS_OTC',
        '11095 11B_ANALGESICOS_OTC (GESTOR)',
        '11096 11C_GASTROINTEST_OTC_(TRACTO_ALIMENT)',
        '11096 11C_GASTROINTEST_OTC_(TRACTO_ALIMENT) (GESTOR)',
        '11097 11D_SUEROS_ORALES_(SUSTIT_ELECTROL_ORAL)',
        '11097 11D_SUEROS_ORALES_(SUSTIT_ELECTROL_ORAL) (GESTOR)',
        '11098 11E_GINECOLOGICOS_OTC_Y_PROD_SEX',
        '11098 11E_GINECOLOGICOS_OTC_Y_PROD_SEX (GESTOR)',
        '11099 11F_DERMATOLOGICOS_OTC',
        '11099 11F_DERMATOLOGICOS_OTC (GESTOR)',
        '11100 11G_OFTALMOLOGICOS_Y_OTICOS_OTC',
        '11100 11G_OFTALMOLOGICOS_Y_OTICOS_OTC (GESTOR)',
        '11101 11H_VITAMINAS_Y_MINERALES_OTC',
        '11101 11H_VITAMINAS_Y_MINERALES_OTC (GESTOR)',
        '11102 11I_NUTRICIONALES_OTC',
        '11102 11I_NUTRICIONALES_OTC (GESTOR)',
        '11104 11K_MATERIAL_Y_ACCESORIOS_PARA_CURACION',
        '11104 11K_MATERIAL_Y_ACCESORIOS_PARA_CURACION (GESTOR)',
        '11105 11L_HIGIENE BUCAL',
        '11105 11L_HIGIENE BUCAL (GESTOR)',
        '11106 11M_ORTOPEDICOS_ACC_TERAP_Y_ME',
        '11106 11M_ORTOPEDICOS_ACC_TERAP_Y_ME (GESTOR)',
        '11107 11N_PRUEBAS_Y_TEST_DE_DIAGNOSTICO',
        '11107 11N_PRUEBAS_Y_TEST_DE_DIAGNOSTICO (GESTOR)',
        '11108 11O_OPTICA',
        '11108 11O_OPTICA (GESTOR)',
        '11109 11P_CUIDADO_DE_LOS_PIES',
        '11109 11P_CUIDADO_DE_LOS_PIES (GESTOR)',
        '11110 11R_PRODUCTOS_NATURALES',
        '11110 11R_PRODUCTOS_NATURALES (GESTOR)',
        '11111 11S_PRODUCTOS_HOMEOPATICOS',
        '11111 11S_PRODUCTOS_HOMEOPATICOS (GESTOR)',
        '11112 11T_OTC_VARIOS',
        '11112 11T_OTC_VARIOS (GESTOR)',
        '11017 ABARROTES_GOURMET',
        '11017 ABARROTES_GOURMET (GESTOR)',
        '11019 ACEITES_COMESTIBLES',
        '11019 ACEITES_COMESTIBLES (GESTOR)',
        '11010 ADEREZOS',
        '11010 ADEREZOS (GESTOR)',
        '11033 AGUA_Y_HIELO',
        '11033 AGUA_Y_HIELO (GESTOR)',
        '11228 ALIMENTOS_REFRIGERADOS',
        '11228 ALIMENTOS_REFRIGERADOS (GESTOR)',
        '11022 AZUCAR_Y_SUSTITUTOS',
        '11022 AZUCAR_Y_SUSTITUTOS (GESTOR)',
        '11018 BARRAS_DE_CEREAL',
        '11018 BARRAS_DE_CEREAL (GESTOR)',
        '11344 BEBES_ACCESORIOS_Y_MUEBLES_INFANTILES.',
        '11249 BEBES_ALIMENTOS',
        '11307 BEBES_ALIMENTOS',
        '11249 BEBES_ALIMENTOS (GESTOR)',
        '11307 BEBES_ALIMENTOS (GESTOR)',
        '11348 BEBES_ALIMENTOS.',
        '11348 BEBES_ALIMENTOS. (GESTOR)',
        '11242 BEBES_BLANCOS',
        '11273 BEBES_CALCETERIA',
        '11300 BEBES_CALCETERIA',
        '11346 BEBES_FORMULAS_INFANTILES.',
        '11242 BEBES_NIÑA',
        '11243 BEBES_NIÑO',
        '11345 BEBES_PAÑALES.',
        '11347 BEBES_PERFUMERIA.',
        '11299 BEBES_ROPA_INTERIOR',
        '11035 BEBIDAS',
        '11367 BEBIDAS',
        '11032 BOTANAS',
        '11032 BOTANAS (GESTOR)',
        '11023 CAFES',
        '11023 CAFES (GESTOR)',
        '11013 CEREALES',
        '11013 CEREALES (GESTOR)',
        '11003 Cereales_Galletas_Y_Panes',
        '11003 Cereales_Galletas_Y_Panes (GESTOR)',
        '11055 CERVEZA',
        '11055 CERVEZA (GESTOR)',
        '11005 CHILES_ENVASADOS',
        '11005 CHILES_ENVASADOS (GESTOR)',
        '11313 CHOCOLATES.',
        '11313 CHOCOLATES. (GESTOR)',
        '11209 CHORIZOS_Y_LONGANIZAS',
        '11209 CHORIZOS_Y_LONGANIZAS (GESTOR)',
        '11231 COMIDAS_CONGELADAS',
        '11231 COMIDAS_CONGELADAS (GESTOR)',
        '11009 COMIDAS_ENVASADAS_Y_ENTREMESES',
        '11009 COMIDAS_ENVASADAS_Y_ENTREMESES (GESTOR)',
        '11034 CONCENTRADOS_PARA_BEBIDAS',
        '11034 CONCENTRADOS_PARA_BEBIDAS (GESTOR)',
        '11008 CONSOMES_Y_CALDOS',
        '11008 CONSOMES_Y_CALDOS (GESTOR)',
        '11224 CREMAS_Y_JOCOQUES',
        '11224 CREMAS_Y_JOCOQUES (GESTOR)',
        '11021 CREMAS,_SOPAS,_PASTAS_Y_PURES',
        '11021 CREMAS,_SOPAS,_PASTAS_Y_PURES (GESTOR)',
        '11208 DELI_GOURMET',
        '11208 DELI_GOURMET (GESTOR)',
        '11310 DESPENSAS.',
        '11310 DESPENSAS. (GESTOR)',
        '11319 DETERGENTES.',
        '11031 DULCERIA',
        '11031 DULCERIA (GESTOR)',
        '11311 DULCERIA.',
        '11311 DULCERIA. (GESTOR)',
        '11161 ENSERES_MENORES',
        '11134 EQUIPAJE_ESCOLAR',
        '11001 ESPECIAS_Y_CONDIMENTOS',
        '11001 ESPECIAS_Y_CONDIMENTOS (GESTOR)',
        '11135 ESTETICA_AUTOMOTRIZ',
        '11140 FIESTA',
        '11343 FIJADORES_Y_MODELADORES.',
        '11172 FRAGANCIAS',
        '11004 FRIJOLES_Y_PLATILLOS_MEXICANOS_ENVASADOS',
        '11004 FRIJOLES_Y_PLATILLOS_MEXICANOS_ENVASADOS (GESTOR)',
        '11064 FRITO_Y_ROSTIZADO',
        '11219 FRUTAS',
        '11349 FUENTE_DE_SODAS.',
        '11014 GALLETAS',
        '11014 GALLETAS (GESTOR)',
        '11225 GELATINAS_Y_POSTRES',
        '11225 GELATINAS_Y_POSTRES (GESTOR)',
        '11020 GRANOS_Y_SEMILLAS',
        '11020 GRANOS_Y_SEMILLAS (GESTOR)',
        '11027 HARINAS_Y_COMPLEMENTOS',
        '11027 HARINAS_Y_COMPLEMENTOS (GESTOR)',
        '11230 HELADOS_Y_POSTRES',
        '11230 HELADOS_Y_POSTRES (GESTOR)',
        '11211 JAMONES',
        '11211 JAMONES (GESTOR)',
        '11029 JUGOS_Y_NECTARES',
        '11029 JUGOS_Y_NECTARES (GESTOR)',
        '11369 JUGOS_Y_NECTARES',
        '11369 JUGOS_Y_NECTARES (GESTOR)',
        '11377 LECHES',
        '11024 LECHES',
        '11229 LECHES_ULTRAPASTEURIZADAS',
        '11229 LECHES_ULTRAPASTEURIZADAS (GESTOR)',
        '11222 LECHES_Y_BEBIDAS_REFREGERADAS',
        '11222 LECHES_Y_BEBIDAS_REFREGERADAS (GESTOR)',
        '11226 MANTEQUILLAS_Y_MARGARINAS',
        '11226 MANTEQUILLAS_Y_MARGARINAS (GESTOR)',
        '11037 MASCOTAS',
        '11315 MASCOTAS.',
        '11123 MEDICAMENTOS_CONTROLADOS',
        '11123 MEDICAMENTOS_CONTROLADOS (GESTOR)',
        '91 MEDICAMENTOS_OTC',
        '91 MEDICAMENTOS_OTC (GESTOR)',
        '100 MEDICINA_ETICA',
        '100 MEDICINA_ETICA (GESTOR)',
        '11016 MERMELADAS,_JALEAS,_MIELES_Y_CAJETAS',
        '11016 MERMELADAS,_JALEAS,_MIELES_Y_CAJETAS (GESTOR)',
        '11012 MOLES_Y_ADOBOS',
        '11012 MOLES_Y_ADOBOS (GESTOR)',
        '11011 PESCADOS_ENVASADOS',
        '11011 PESCADOS_ENVASADOS (GESTOR)',
        '11221 PESCADOS_Y_MARISCOS',
        '11221 PESCADOS_Y_MARISCOS (GESTOR)',
        '11015 PINA_REBANADAS',
        '11015 PINA_REBANADAS (GESTOR)',
        '11114 PLAN_DE_FIDELIDAD_MG',
        '11114 PLAN_DE_FIDELIDAD_MG (GESTOR)',
        '11028 POSTRES',
        '11028 POSTRES (GESTOR)',
        '11223 QUESOS',
        '11223 QUESOS (GESTOR)',
        '11030 REFRESCOS',
        '11030 REFRESCOS (GESTOR)',
        '11026 SABORIZANTES_PARA_LECHE_Y_CAFE',
        '11026 SABORIZANTES_PARA_LECHE_Y_CAFE (GESTOR)',
        '11212 SALCHICHAS',
        '11212 SALCHICHAS (GESTOR)',
        '11007 SALSAS_ENVASADAS',
        '11007 SALSAS_ENVASADAS (GESTOR)',
        '11113 SIN_CATEGORIA_FARM',
        '11113 SIN_CATEGORIA_FARM (GESTOR)',
        '11241 SIN_CATEGORIA_(PRO_ESP)',
        '11241 SIN_CATEGORIA_(PRO_ESP) (GESTOR)',
        '11201 TARJETAS_Y_SORTEOS_DE_AYUDA',
        '11201 TARJETAS_Y_SORTEOS_DE_AYUDA (GESTOR)',
        '11025 TES_DE_INFUSION',
        '11025 TES_DE_INFUSION (GESTOR)',
        '11210 TOCINOS',
        '11210 TOCINOS (GESTOR)',
         }
    .scrollbar-custom::-webkit-scrollbar-thumb {
      background-color: #cbd5e1;
      border-radius: 10px;
    }
    .notification {
      position: fixed;
      top: 1rem;
      right: 1rem;
      padding: 1rem;
      background-color: #1f2937;
      color: white;
      border-radius: 0.5rem;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      transform: translateX(100%);
      animation: slideInNotification 0.3s ease-out forwards;
    }
    @keyframes slideInNotification {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    .stat-card {
      transition: all 0.3s ease;
    }
    .stat-card:hover {
      transform: translateY(-2px);
    }
    @media (max-width: 640px) {
      .floating-button {
        width: 3.5rem;
        height: 3.5rem;
        bottom: 1rem;
        right: 1rem;
      }
      .product-details {
        flex-direction: column;
      }
      .product-image {
        margin-bottom: 1rem;
      }
    }
    .status-fresh {
      background-color: #dcfce7;
      color: #166534;
      border: 1px solid #86efac;
    }
    .status-warning {
      background-color: #fef3c7;
      color: #92400e;
      border: 1px solid #fde68a;
    }
    .status-expired {
      background-color: #fee2e2;
      color: #991b1b;
      border: 1px solid #fca5a5;
    }
    .product-card {
      transition: all 0.3s ease;
      border: 1px solid #e5e7eb;
    }
    .product-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }
    .modal {
      transition: all 0.3s ease;
    }
    .fade-in {
      animation: fadeIn 0.3s ease-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .slide-in {
      animation: slideIn 0.3s ease-out;
    }
    @keyframes slideIn {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .toggle-checkbox:checked {
      right: 0;
      border-color: #68D391;
      transform: translateX(20px);
    }
    .toggle-checkbox:checked + .toggle-label {
      background-color: #68D391;
    }
    .toggle-label {
      transition: all 0.2s ease;
    }
    .category-slider {
      scrollbar-width: thin;
      -ms-overflow-style: none;
      max-height: 200px;
      overflow-y: auto;
    }
    .category-slider::-webkit-scrollbar {
      display: none;
    }
    .floating-button {
      width: 3.5rem;
      height: 3.5rem;
      background-color: #2563eb;
      color: white;
      border-radius: 9999px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      transition: all 0.2s ease;
      z-index: 10;
      backdrop-filter: blur(10px);
    }
    .floating-button:hover {
      background-color: #1d4ed8;
      transform: scale(1.1);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-gray-900 dark:text-gray-100 transition-colors duration-300">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef, useMemo } = React;

    // Database helper for IndexedDB
    const useIndexedDB = () => {
      const DB_NAME = 'ExpiryControlDB';
      const DB_VERSION = 1;
      const STORE_NAME = 'products';
      const CONFIG_STORE = 'config';

      const openDB = () => {
        return new Promise((resolve, reject) => {
          const request = indexedDB.open(DB_NAME, DB_VERSION);

          request.onerror = () => reject(request.error);
          request.onsuccess = () => resolve(request.result);

          request.onupgradeneeded = (event) => {
            const db = event.target.result;
            
            // Create products store if it doesn't exist
            if (!db.objectStoreNames.contains(STORE_NAME)) {
              const productStore = db.createObjectStore(STORE_NAME, { keyPath: 'id' });
              productStore.createIndex('name', 'name', { unique: false });
              productStore.createIndex('category', 'category', { unique: false });
              productStore.createIndex('expiryDate', 'expiryDate', { unique: false });
            }
            
            // Create config store if it doesn't exist
            if (!db.objectStoreNames.contains(CONFIG_STORE)) {
              db.createObjectStore(CONFIG_STORE, { keyPath: 'key' });
            }
          };
        });
      };

      const getProducts = async () => {
        const db = await openDB();
        return new Promise((resolve, reject) => {
          const transaction = db.transaction([STORE_NAME], 'readonly');
          const store = transaction.objectStore(STORE_NAME);
          const request = store.getAll();

          request.onsuccess = () => resolve(request.result);
          request.onerror = () => reject(request.error);
        });
      };

      const saveProducts = async (products) => {
        const db = await openDB();
        return new Promise((resolve, reject) => {
          const transaction = db.transaction([STORE_NAME], 'readwrite');
          const store = transaction.objectStore(STORE_NAME);
          
          // Clear existing data
          store.clear();
          
          // Add new data
          if (Array.isArray(products) && products.length > 0) {
            products.forEach(product => store.add(product));
          }

          transaction.oncomplete = () => resolve();
          transaction.onerror = () => reject(transaction.error);
        });
      };

      const getConfig = async (key) => {
        const db = await openDB();
        return new Promise((resolve, reject) => {
          const transaction = db.transaction([CONFIG_STORE], 'readonly');
          const store = transaction.objectStore(CONFIG_STORE);
          const request = store.get(key);

          request.onsuccess = () => resolve(request.result ? request.result.value : null);
          request.onerror = () => reject(request.error);
        });
      };

      const saveConfig = async (key, value) => {
        const db = await openDB();
        return new Promise((resolve, reject) => {
          const transaction = db.transaction([CONFIG_STORE], 'readwrite');
          const store = transaction.objectStore(CONFIG_STORE);
          
          // Check if key exists
          const getRequest = store.get(key);
          
          getRequest.onsuccess = () => {
            if (getRequest.result) {
              // Update existing
              store.put({ key, value });
            } else {
              // Add new
              store.add({ key, value });
            }
          };

          transaction.oncomplete = () => resolve();
          transaction.onerror = () => reject(transaction.error);
        });
      };

      return { getProducts, saveProducts, getConfig, saveConfig };
    };

    // Componente principal
    const App = () => {
      const db = useIndexedDB();
      
      // Estado principal
      const [darkMode, setDarkMode] = useState(false);
      const [products, setProducts] = useState([]);
      const [showModal, setShowModal] = useState(false);
      const [currentProduct, setCurrentProduct] = useState(null);
      const [searchTerm, setSearchTerm] = useState('');
      const [filterCategory, setFilterCategory] = useState('');
      const [categoryAlerts, setCategoryAlerts] = useState({});
      const [showSettings, setShowSettings] = useState(false);
      const [notification, setNotification] = useState(null);
      const [isLoading, setIsLoading] = useState(true);

      const fileInputRef = useRef(null);

      // Categorías predefinidas
      const categories = [
        '11054 CIGARROS',
        '11076 10A_TRACTO ALIMENTARIO Y METABOLISMO',
        '11076 10A_TRACTO ALIMENTARIO Y METABOLISMO (GESTOR)',
        '11077 10B_SANGRE Y APARATO HEMATOPOYETICO',
        '11077 10B_SANGRE Y APARATO HEMATOPOYETICO (GESTOR)',
        '11078 10C_SISTEMA CARDIOVASCULAR',
        '11078 10C_SISTEMA CARDIOVASCULAR (GESTOR)',
        '11079 10D_DERMATOLOGICOS',
        '11079 10D_DERMATOLOGICOS (GESTOR)',
        '11296 10E ESPECIALIZADOS',
        '11296 10E ESPECIALIZADOS (GESTOR)',
        '11080 10G_SIST GENITOURINARIO Y HORMONAS SEX',
        '11080 10G_SIST GENITOURINARIO Y HORMONAS SEX (GESTOR)',
        '11081 10H_PREP HORM SIST (EXCLUY HORMONAS SEX)',
        '11081 10H_PREP HORM SIST (EXCLUY HORMONAS SEX) (GESTOR)',
        '11082 10J_ANTIINFECCIOSOS SISTEMICOS GENERALES',
        '11082 10J_ANTIINFECCIOSOS SISTEMICOS GENERALES (GESTOR)',
        '11083 10K_SOLUCIONES HOSPITALARIAS',
        '11083 10K_SOLUCIONES HOSPITALARIAS (GESTOR)',
        '11084 10L_ANTINEOPLASICOS_Y_AGTS_INMUNOMODUL',
        '11084 10L_ANTINEOPLASICOS_Y_AGTS_INMUNOMODUL (GESTOR)',
        '11085 10M_SISTEMA_MUSCULO_ESQUELETICO',
        '11085 10M_SISTEMA_MUSCULO_ESQUELETICO (GESTOR)',
        '11086 10N_SISTEMA_NERVIOSO_CENTRAL',
        '11086 10N_SISTEMA_NERVIOSO_CENTRAL (GESTOR)',
        '11087 10P_PARASITOLOGIA',
        '11087 10P_PARASITOLOGIA (GESTOR)',
        '11088 10R_SISTEMA_RESPIRATORIO',
        '11088 10R_SISTEMA_RESPIRATORIO (GESTOR)',
        '11089 10S_ORGANOS_DE_LOS_SENTIDOS',
        '11089 10S_ORGANOS_DE_LOS_SENTIDOS (GESTOR)',
        '11090 10T_AGENTES_DE_DIAGNOSTICO',
        '11090 10T_AGENTES_DE_DIAGNOSTICO (GESTOR)',
        '11091 10V_VARIOS',
        '11091 10V_VARIOS (GESTOR)',
        '11092 10W_PRODUCTOS_NATURALES',
        '11092 10W_PRODUCTOS_NATURALES (GESTOR)',
        '11297 10Y_REFREGERADOS',
        '11297 10Y_REFREGERADOS (GESTOR)',
        '11298 10Z_CONTROLADOS',
        '11298 10Z_CONTROLADOS (GESTOR)',
        '11094 11A_RESPIRATORIOS_OTC',
        '11094 11A_RESPIRATORIOS_OTC (GESTOR)',
        '11095 11B_ANALGESICOS_OTC',
        '11095 11B_ANALGESICOS_OTC (GESTOR)',
        '11096 11C_GASTROINTEST_OTC_(TRACTO_ALIMENT)',
        '11096 11C_GASTROINTEST_OTC_(TRACTO_ALIMENT) (GESTOR)',
        '11097 11D_SUEROS_ORALES_(SUSTIT_ELECTROL_ORAL)',
        '11097 11D_SUEROS_ORALES_(SUSTIT_ELECTROL_ORAL) (GESTOR)',
        '11098 11E_GINECOLOGICOS_OTC_Y_PROD_SEX',
        '11098 11E_GINECOLOGICOS_OTC_Y_PROD_SEX (GESTOR)',
        '11099 11F_DERMATOLOGICOS_OTC',
        '11099 11F_DERMATOLOGICOS_OTC (GESTOR)',
        '11100 11G_OFTALMOLOGICOS_Y_OTICOS_OTC',
        '11100 11G_OFTALMOLOGICOS_Y_OTICOS_OTC (GESTOR)',
        '11101 11H_VITAMINAS_Y_MINERALES_OTC',
        '11101 11H_VITAMINAS_Y_MINERALES_OTC (GESTOR)',
        '11102 11I_NUTRICIONALES_OTC',
        '11102 11I_NUTRICIONALES_OTC (GESTOR)',
        '11104 11K_MATERIAL_Y_ACCESORIOS_PARA_CURACION',
        '11104 11K_MATERIAL_Y_ACCESORIOS_PARA_CURACION (GESTOR)',
        '11105 11L_HIGIENE BUCAL',
        '11105 11L_HIGIENE BUCAL (GESTOR)',
        '11106 11M_ORTOPEDICOS_ACC_TERAP_Y_ME',
        '11106 11M_ORTOPEDICOS_ACC_TERAP_Y_ME (GESTOR)',
        '11107 11N_PRUEBAS_Y_TEST_DE_DIAGNOSTICO',
        '11107 11N_PRUEBAS_Y_TEST_DE_DIAGNOSTICO (GESTOR)',
        '11108 11O_OPTICA',
        '11108 11O_OPTICA (GESTOR)',
        '11109 11P_CUIDADO_DE_LOS_PIES',
        '11109 11P_CUIDADO_DE_LOS_PIES (GESTOR)',
        '11110 11R_PRODUCTOS_NATURALES',
        '11110 11R_PRODUCTOS_NATURALES (GESTOR)',
        '11111 11S_PRODUCTOS_HOMEOPATICOS',
        '11111 11S_PRODUCTOS_HOMEOPATICOS (GESTOR)',
        '11112 11T_OTC_VARIOS',
        '11112 11T_OTC_VARIOS (GESTOR)',
        '11017 ABARROTES_GOURMET',
        '11017 ABARROTES_GOURMET (GESTOR)',
        '11019 ACEITES_COMESTIBLES',
        '11019 ACEITES_COMESTIBLES (GESTOR)',
        '11010 ADEREZOS',
        '11010 ADEREZOS (GESTOR)',
        '11033 AGUA_Y_HIELO',
        '11033 AGUA_Y_HIELO (GESTOR)',
        '11228 ALIMENTOS_REFRIGERADOS',
        '11228 ALIMENTOS_REFRIGERADOS (GESTOR)',
        '11022 AZUCAR_Y_SUSTITUTOS',
        '11022 AZUCAR_Y_SUSTITUTOS (GESTOR)',
        '11018 BARRAS_DE_CEREAL',
        '11018 BARRAS_DE_CEREAL (GESTOR)',
        '11344 BEBES_ACCESORIOS_Y_MUEBLES_INFANTILES.',
        '11249 BEBES_ALIMENTOS',
        '11307 BEBES_ALIMENTOS',
        '11249 BEBES_ALIMENTOS (GESTOR)',
        '11307 BEBES_ALIMENTOS (GESTOR)',
        '11348 BEBES_ALIMENTOS.',
        '11348 BEBES_ALIMENTOS. (GESTOR)',
        '11242 BEBES_BLANCOS',
        '11273 BEBES_CALCETERIA',
        '11300 BEBES_CALCETERIA',
        '11346 BEBES_FORMULAS_INFANTILES.',
        '11242 BEBES_NIÑA',
        '11243 BEBES_NIÑO',
        '11345 BEBES_PAÑALES.',
        '11347 BEBES_PERFUMERIA.',
        '11299 BEBES_ROPA_INTERIOR',
        '11035 BEBIDAS',
        '11367 BEBIDAS',
        '11032 BOTANAS',
        '11032 BOTANAS (GESTOR)',
        '11023 CAFES',
        '11023 CAFES (GESTOR)',
        '11013 CEREALES',
        '11013 CEREALES (GESTOR)',
        '11003 Cereales_Galletas_Y_Panes',
        '11003 Cereales_Galletas_Y_Panes (GESTOR)',
        '11055 CERVEZA',
        '11055 CERVEZA (GESTOR)',
        '11005 CHILES_ENVASADOS',
        '11005 CHILES_ENVASADOS (GESTOR)',
        '11313 CHOCOLATES.',
        '11313 CHOCOLATES. (GESTOR)',
        '11209 CHORIZOS_Y_LONGANIZAS',
        '11209 CHORIZOS_Y_LONGANIZAS (GESTOR)',
        '11231 COMIDAS_CONGELADAS',
        '11231 COMIDAS_CONGELADAS (GESTOR)',
        '11009 COMIDAS_ENVASADAS_Y_ENTREMESES',
        '11009 COMIDAS_ENVASADAS_Y_ENTREMESES (GESTOR)',
        '11034 CONCENTRADOS_PARA_BEBIDAS',
        '11034 CONCENTRADOS_PARA_BEBIDAS (GESTOR)',
        '11008 CONSOMES_Y_CALDOS',
        '11008 CONSOMES_Y_CALDOS (GESTOR)',
        '11224 CREMAS_Y_JOCOQUES',
        '11224 CREMAS_Y_JOCOQUES (GESTOR)',
        '11021 CREMAS,_SOPAS,_PASTAS_Y_PURES',
        '11021 CREMAS,_SOPAS,_PASTAS_Y_PURES (GESTOR)',
        '11208 DELI_GOURMET',
        '11208 DELI_GOURMET (GESTOR)',
        '11310 DESPENSAS.',
        '11310 DESPENSAS. (GESTOR)',
        '11319 DETERGENTES.',
        '11031 DULCERIA',
        '11031 DULCERIA (GESTOR)',
        '11311 DULCERIA.',
        '11311 DULCERIA. (GESTOR)',
        '11161 ENSERES_MENORES',
        '11134 EQUIPAJE_ESCOLAR',
        '11001 ESPECIAS_Y_CONDIMENTOS',
        '11001 ESPECIAS_Y_CONDIMENTOS (GESTOR)',
        '11135 ESTETICA_AUTOMOTRIZ',
        '11140 FIESTA',
        '11343 FIJADORES_Y_MODELADORES.',
        '11172 FRAGANCIAS',
        '11004 FRIJOLES_Y_PLATILLOS_MEXICANOS_ENVASADOS',
        '11004 FRIJOLES_Y_PLATILLOS_MEXICANOS_ENVASADOS (GESTOR)',
        '11064 FRITO_Y_ROSTIZADO',
        '11219 FRUTAS',
        '11349 FUENTE_DE_SODAS.',
        '11014 GALLETAS',
        '11014 GALLETAS (GESTOR)',
        '11225 GELATINAS_Y_POSTRES',
        '11225 GELATINAS_Y_POSTRES (GESTOR)',
        '11020 GRANOS_Y_SEMILLAS',
        '11020 GRANOS_Y_SEMILLAS (GESTOR)',
        '11027 HARINAS_Y_COMPLEMENTOS',
        '11027 HARINAS_Y_COMPLEMENTOS (GESTOR)',
        '11230 HELADOS_Y_POSTRES',
        '11230 HELADOS_Y_POSTRES (GESTOR)',
        '11211 JAMONES',
        '11211 JAMONES (GESTOR)',
        '11029 JUGOS_Y_NECTARES',
        '11029 JUGOS_Y_NECTARES (GESTOR)',
        '11369 JUGOS_Y_NECTARES',
        '11369 JUGOS_Y_NECTARES (GESTOR)',
        '11377 LECHES',
        '11024 LECHES',
        '11229 LECHES_ULTRAPASTEURIZADAS',
        '11229 LECHES_ULTRAPASTEURIZADAS (GESTOR)',
        '11222 LECHES_Y_BEBIDAS_REFREGERADAS',
        '11222 LECHES_Y_BEBIDAS_REFREGERADAS (GESTOR)',
        '11226 MANTEQUILLAS_Y_MARGARINAS',
        '11226 MANTEQUILLAS_Y_MARGARINAS (GESTOR)',
        '11037 MASCOTAS',
        '11315 MASCOTAS.',
        '11123 MEDICAMENTOS_CONTROLADOS',
        '11123 MEDICAMENTOS_CONTROLADOS (GESTOR)',
        '91 MEDICAMENTOS_OTC',
        '91 MEDICAMENTOS_OTC (GESTOR)',
        '100 MEDICINA_ETICA',
        '100 MEDICINA_ETICA (GESTOR)',
        '11016 MERMELADAS,_JALEAS,_MIELES_Y_CAJETAS',
        '11016 MERMELADAS,_JALEAS,_MIELES_Y_CAJETAS (GESTOR)',
        '11012 MOLES_Y_ADOBOS',
        '11012 MOLES_Y_ADOBOS (GESTOR)',
        '11011 PESCADOS_ENVASADOS',
        '11011 PESCADOS_ENVASADOS (GESTOR)',
        '11221 PESCADOS_Y_MARISCOS',
        '11221 PESCADOS_Y_MARISCOS (GESTOR)',
        '11015 PINA_REBANADAS',
        '11015 PINA_REBANADAS (GESTOR)',
        '11114 PLAN_DE_FIDELIDAD_MG',
        '11114 PLAN_DE_FIDELIDAD_MG (GESTOR)',
        '11028 POSTRES',
        '11028 POSTRES (GESTOR)',
        '11223 QUESOS',
        '11223 QUESOS (GESTOR)',
        '11030 REFRESCOS',
        '11030 REFRESCOS (GESTOR)',
        '11026 SABORIZANTES_PARA_LECHE_Y_CAFE',
        '11026 SABORIZANTES_PARA_LECHE_Y_CAFE (GESTOR)',
        '11212 SALCHICHAS',
        '11212 SALCHICHAS (GESTOR)',
        '11007 SALSAS_ENVASADAS',
        '11007 SALSAS_ENVASADAS (GESTOR)',
        '11113 SIN_CATEGORIA_FARM',
        '11113 SIN_CATEGORIA_FARM (GESTOR)',
        '11241 SIN_CATEGORIA_(PRO_ESP)',
        '11241 SIN_CATEGORIA_(PRO_ESP) (GESTOR)',
        '11201 TARJETAS_Y_SORTEOS_DE_AYUDA',
        '11201 TARJETAS_Y_SORTEOS_DE_AYUDA (GESTOR)',
        '11025 TES_DE_INFUSION',
        '11025 TES_DE_INFUSION (GESTOR)',
        '11210 TOCINOS',
        '11210 TOCINOS (GESTOR)',
        '11002 TORTILLAS_Y_TOSTADAS_EMPACADAS',
        '11002 TORTILLAS_Y_TOSTADAS_EMPACADAS (GESTOR)',
        '11059 TORTILLERIA',
        '11146 VEHICULOS_DE_MOTOR_A_GASOLINA',
        '11323 VELAS_Y_VELADORAS.',
        '11220 VERDURAS',
        '11006 VERDURAS_Y_VEGETALES_ENVASADOS',
        '11006 VERDURAS_Y_VEGETALES_ENVASADOS (GESTOR)',
        '11124 VIDEO',
        '11056 VINOS_DE_MESA',
        '11227 YOGHURT',
        '11227 YOGHURT (GESTOR)'
      ];

      // Configuración de etapas por categoría
      const stageConfig = {
        "10A_TRACTO_ALIMENTARIO_Y_METABOLISMO": { etapa1: 90, etapa2: 60, etapa3: 30 },
        "10B_SANGRE_Y_APARATO_HEMATOPOYETICO": { etapa1: 90, etapa2: 60, etapa3: 30 },
        "10C_SISTEMA_CARDIOVASCULAR": { etapa1: 90, etapa2: 60, etapa3: 30 },
        "10D_DERMATOLOGICOS": { etapa1: 90, etapa2: 60, etapa3: 30 },
        "10E_ESPECIALIZADOS": { etapa1: 90, etapa2: 60, etapa3: 30 },
        "10G_SIST_GENITOURINARIO_Y_HORMONAS_SEX": { etapa1: 90, etapa2: 60, etapa3: 30 },
        "10H_PREP_HORM_SIST_(EXCLUY_HORMONAS_SEX)": { etapa1: 90, etapa2: 60, etapa3: 30 },
        "10J_ANTIINFECCIOSOS_SISTEMICOS_GENERALES":     }
    .scrollbar-custom::-webkit-scrollbar-thumb {
      background-color: #cbd5e1;
      border-radius: 10px;
    }
    .toast {
      animation: slideIn 0.3s ease-out;
    }
    @keyframes slideIn {
      from { transform: translateY(-100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .fade-enter {
      opacity: 0;
      transform: translateY(-10px);
    }
    .fade-enter-active {
      opacity: 1;
      transform: translateY(0);
      transition: all 0.3s ease;
    }
    .fade-exit {
      opacity: 1;
    }
    .fade-exit-active {
      opacity: 0;
      transform: translateY(-10px);
      transition: all 0.3s ease;
    }
    .notification {
      position: fixed;
      top: 1rem;
      right: 1rem;
      padding: 1rem;
      background-color: #1f2937;
      color: white;
      border-radius: 0.5rem;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      transform: translateX(100%);
      animation: slideInNotification 0.3s ease-out forwards;
    }
    @keyframes slideInNotification {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    .stat-card {
      transition: all 0.3s ease;
    }
    .stat-card:hover {
      transform: translateY(-2px);
    }
    @media (max-width: 640px) {
      .floating-button {
        width: 3.5rem;
        height: 3.5rem;
        bottom: 1rem;
        right: 1rem;
      }
      .product-details {
        flex-direction: column;
      }
      .product-image {
        margin-bottom: 1rem;
      }
    }
    .status-fresh {
      background-color: #dcfce7;
      color: #166534;
      border: 1px solid #86efac;
    }
    .status-warning {
      background-color: #fef3c7;
      color: #92400e;
      border: 1px solid #fde68a;
    }
    .status-expired {
      background-color: #fee2e2;
      color: #991b1b;
      border: 1px solid #fca5a5;
    }
    .product-card {
      transition: all 0.3s ease;
      border: 1px solid #e5e7eb;
    }
    .product-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }
    .modal {
      transition: all 0.3s ease;
    }
    .fade-in {
      animation: fadeIn 0.3s ease-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .slide-in {
      animation: slideIn 0.3s ease-out;
    }
    @keyframes slideIn {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .toggle-checkbox:checked {
      right: 0;
      border-color: #68D391;
      transform: translateX(20px);
    }
    .toggle-checkbox:checked + .toggle-label {
      background-color: #68D391;
    }
    .toggle-label {
      transition: all 0.2s ease;
    }
    .category-slider {
      scrollbar-width: thin;
      -ms-overflow-style: none;
      max-height: 200px;
      overflow-y: auto;
    }
    .category-slider::-webkit-scrollbar {
      display: none;
    }
    .floating-button {
      width: 3.5rem;
      height: 3.5rem;
      background-color: #2563eb;
      color: white;
      border-radius: 9999px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      transition: all 0.2s ease;
      z-index: 10;
      backdrop-filter: blur(10px);
    }
    .floating-button:hover {
      background-color: #1d4ed8;
      transform: scale(1.1);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-gray-900 dark:text-gray-100 transition-colors duration-300">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef, useMemo } = React;

    // Database helper for IndexedDB
    const useIndexedDB = () => {
      const DB_NAME = 'ExpiryControlDB';
      const DB_VERSION = 1;
      const STORE_NAME = 'products';
      const CONFIG_STORE = 'config';

      const openDB = () => {
        return new Promise((resolve, reject) => {
          const request = indexedDB.open(DB_NAME, DB_VERSION);

          request.onerror = () => reject(request.error);
          request.onsuccess = () => resolve(request.result);

          request.onupgradeneeded = (event) => {
            const db = event.target.result;
            
            // Create products store if it doesn't exist
            if (!db.objectStoreNames.contains(STORE_NAME)) {
              const productStore = db.createObjectStore(STORE_NAME, { keyPath: 'id' });
              productStore.createIndex('name', 'name', { unique: false });
              productStore.createIndex('category', 'category', { unique: false });
              productStore.createIndex('expiryDate', 'expiryDate', { unique: false });
            }
            
            // Create config store if it doesn't exist
            if (!db.objectStoreNames.contains(CONFIG_STORE)) {
              db.createObjectStore(CONFIG_STORE, { keyPath: 'key' });
            }
          };
        });
      };

      const getProducts = async () => {
        const db = await openDB();
        return new Promise((resolve, reject) => {
          const transaction = db.transaction([STORE_NAME], 'readonly');
          const store = transaction.objectStore(STORE_NAME);
          const request = store.getAll();

          request.onsuccess = () => resolve(request.result);
          request.onerror = () => reject(request.error);
        });
      };

      const saveProducts = async (products) => {
        const db = await openDB();
        return new Promise((resolve, reject) => {
          const transaction = db.transaction([STORE_NAME], 'readwrite');
          const store = transaction.objectStore(STORE_NAME);
          
          // Clear existing data
          store.clear();
          
          // Add new data
          if (Array.isArray(products) && products.length > 0) {
            products.forEach(product => store.add(product));
          }

          transaction.oncomplete = () => resolve();
          transaction.onerror = () => reject(transaction.error);
        });
      };

      const getConfig = async (key) => {
        const db = await openDB();
        return new Promise((resolve, reject) => {
          const transaction = db.transaction([CONFIG_STORE], 'readonly');
          const store = transaction.objectStore(CONFIG_STORE);
          const request = store.get(key);

          request.onsuccess = () => resolve(request.result ? request.result.value : null);
          request.onerror = () => reject(request.error);
        });
      };

      const saveConfig = async (key, value) => {
        const db = await openDB();
        return new Promise((resolve, reject) => {
          const transaction = db.transaction([CONFIG_STORE], 'readwrite');
          const store = transaction.objectStore(CONFIG_STORE);
          
          // Check if key exists
          const getRequest = store.get(key);
          
          getRequest.onsuccess = () => {
            if (getRequest.result) {
              // Update existing
              store.put({ key, value });
            } else {
              // Add new
              store.add({ key, value });
            }
          };

          transaction.oncomplete = () => resolve();
          transaction.onerror = () => reject(transaction.error);
        });
      };

      return { getProducts, saveProducts, getConfig, saveConfig };
    };

    // Componente principal
    const App = () => {
      const db = useIndexedDB();
      
      // Estado principal
      const [darkMode, setDarkMode] = useState(false);
      const [products, setProducts] = useState([]);
      const [showModal, setShowModal] = useState(false);
      const [currentProduct, setCurrentProduct] = useState(null);
      const [activeTab, setActiveTab] = useState('all');
      const [searchTerm, setSearchTerm] = useState('');
      const [filterCategory, setFilterCategory] = useState('');
      const [categoryAlerts, setCategoryAlerts] = useState({});
      const [showSettings, setShowSettings] = useState(false);
      const [notification, setNotification] = useState(null);
      const [showScanner, setShowScanner] = useState(false);
      const [barcodeResult, setBarcodeResult] = useState('');
      const [importModal, setImportModal] = useState(false);
      const [exportModal, setExportModal] = useState(false);
      const [isLoading, setIsLoading] = useState(true);

      const fileInputRef = useRef(null);
      const videoRef = useRef(null);
      const canvasRef = useRef(null);
      const streamRef = useRef(null);

      // Categorías predefinidas con alertas
      const defaultCategoryAlerts = {
        '11076 10A_TRACTO ALIMENTARIO Y METABOLISMO': 90,
        '11077 10B_SANGRE Y APARATO HEMATOPOYETICO': 90,
        '11078 10C_SISTEMA CARDIOVASCULAR': 90,
        '11079 10D_DERMATOLOGICOS': 90,
        '11296 10E ESPECIALIZADOS': 90,
        '11080 10G_SIST GENITOURINARIO Y HORMONAS SEX': 90,
        '11081 10H_PREP HORM SIST (EXCLUY HORMONAS SEX)': 90,
        '11082 10J_ANTIINFECCIOSOS SISTEMICOS GENERALES': 90,
        '11083 10K_SOLUCIONES HOSPITALARIAS': 90,
        '11084 10L_ANTINEOPLASICOS_Y_AGTS_INMUNOMODUL': 90,
        '11085 10M_SISTEMA_MUSCULO_ESQUELETICO': 90,
        '11086 10N_SISTEMA_NERVIOSO_CENTRAL': 90,
        '11087 10P_PARASITOLOGIA': 90,
        '11088 10R_SISTEMA_RESPIRATORIO': 90,
        '11089 10S_ORGANOS_DE_LOS_SENTIDOS': 90,
        '11090 10T_AGENTES_DE_DIAGNOSTICO': 90,
        '11091 10V_VARIOS': 90,
        '11092 10W_PRODUCTOS_NATURALES': 90,
        '11297 10Y_REFREGERADOS': 90,
        '11298 10Z_CONTROLADOS': 90,
        '11094 11A_RESPIRATORIOS_OTC': 90,
        '11095 11B_ANALGESICOS_OTC': 90,
        '11096 11C_GASTROINTEST_OTC_(TRACTO_ALIMENT)': 90,
        '11097 11D_SUEROS_ORALES_(SUSTIT_ELECTROL_ORAL)': 90,
        '11098 11E_GINECOLOGICOS_OTC_Y_PROD_SEX': 90,
        '11099 11F_DERMATOLOGICOS_OTC': 90,
        '11100 11G_OFTALMOLOGICOS_Y_OTICOS_OTC': 90,
        '11101 11H_VITAMINAS_Y_MINERALES_OTC': 90,
        '11102 11I_NUTRICIONALES_OTC': 90,
        '11104 11K_MATERIAL_Y_ACCESORIOS_PARA_CURACION': 90,
        '11106 11M_ORTOPEDICOS_ACC_TERAP_Y_ME': 90,
        '11107 11N_PRUEBAS_Y_TEST_DE_DIAGNOSTICO': 90,
        '11109 11P_CUIDADO_DE_LOS_PIES': 90,
        '11110 11R_PRODUCTOS_NATURALES': 90,
        '11111 11S_PRODUCTOS_HOMEOPATICOS': 90,
        '11112 11T_OTC_VARIOS': 90,
        '11017 ABARROTES_GOURMET': 40,
        '11019 ACEITES_COMESTIBLES': 90,
        '11010 ADEREZOS': 40,
        '11033 AGUA_Y_HIELO': 90,
        '11228 ALIMENTOS_REFRIGERADOS': 10,
        '11022 AZUCAR_Y_SUSTITUTOS': 90,
        '11018 BARRAS_DE_CEREAL': 40,
        '11249 BEBES_ALIMENTOS': 30,
        '11307 BEBES_ALIMENTOS': 30,
        '11348 BEBES_ALIMENTOS.': 30,
        '11035 BEBIDAS': 90,
        '11367 BEBIDAS': 90,
        '11032 BOTANAS': 30,
        '11023 CAFES': 90,
        '11013 CEREALES': 40,
        '11003 Cereales_Galletas_Y_Panes': 40,
        '11055 CERVEZA': 40,
        '11005 CHILES_ENVASADOS': 40,
        '11313 CHOCOLATES.': 45,
        '11209 CHORIZOS_Y_LONGANIZAS': 30,
        '11231 COMIDAS_CONGELADAS': 30,
        '11009 COMIDAS_ENVASADAS_Y_ENTREMESES': 40,
        '11034 CONCENTRADOS_PARA_BEBIDAS': 90,
        '11008 CONSOMES_Y_CALDOS': 40,
        '11224 CREMAS_Y_JOCOQUES': 10,
        '11021 CREMAS,_SOPAS,_PASTAS_Y_PURES': 90,
        '11208 DELI_GOURMET': 15,
        '11016 MERMELADAS,_JALEAS,_MIELES_Y_CAJETAS': 40,
        '11012 MOLES_Y_ADOBOS': 40,
        '11002 TORTILLAS_Y_TOSTADAS_EMPACADAS': 30,
        '11006 VERDURAS_Y_VEGETALES_ENVASADOS': 40,
        '11227 YOGHURT': 20,
        '91 MEDICAMENTOS_OTC': 90,
        '100 MEDICINA_ETICA': 90,
        '11223 QUESOS': 15,
        '11030 REFRESCOS': 30,
        '11026 SABORIZANTES_PARA_LECHE_Y_CAFE': 90,
        '11212 SALCHICHAS': 20,
        '11210 TOCINOS': 30,
        '11211 JAMONES': 30,
        '11205 CARNE_DE_RES': 30,
        '11206 CARNE_DE_CERDO': 30,
        '11217 CARNE_DE_POLLO': 30,
        '11218 CARNE_DE_PAVO': 30,
        '11214 CARNE_SECA_Y_CHICHARRON_PRENSADO': 30,
        '11221 PESCADOS_Y_MARISCOS': 40,
        '11011 PESCADOS_ENVASADOS': 40,
        '11377 LECHES': 90,
        '11024 LECHES': 90,
        '11229 LECHES_ULTRAPASTEURIZADAS': 30,
        '11222 LECHES_Y_BEBIDAS_REFREGERADAS': 6,
        '11226 MANTEQUILLAS_Y_MARGARINAS': 30,
        '11037 MASCOTAS': 90,
        '11315 MASCOTAS.': 90
      };

      // Efecto para cargar datos del IndexedDB
      useEffect(() => {
        const loadData = async () => {
          try {
            // Cargar productos
            const savedProducts = await db.getProducts();
            if (savedProducts && Array.isArray(savedProducts)) {
              setProducts(savedProducts);
            }

            // Cargar modo oscuro
            const savedDarkMode = await db.getConfig('darkMode');
            if (savedDarkMode !== null) {
              setDarkMode(savedDarkMode === 'true');
            } else {
              // Detectar preferencia del sistema
              const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
              setDarkMode(systemPrefersDark);
            }

            // Cargar alertas
            const savedAlerts = await db.getConfig('categoryAlerts');
            if (savedAlerts) {
              setCategoryAlerts(savedAlerts);
            } else {
              setCategoryAlerts(defaultCategoryAlerts);
            }
          } catch (error) {
            console.error('Error loading data from IndexedDB:', error);
            // Usar valores por defecto en caso de error
            setProducts([]);
            setCategoryAlerts(defaultCategoryAlerts);
            setDarkMode(window.matchMedia('(prefers-color-scheme: dark)').matches);
          } finally {
            setIsLoading(false);
          }
        };

        loadData();
      }, []);

      // Efecto para guardar productos en IndexedDB
      useEffect(() => {
        if (isLoading) return;
        
        const saveData = async () => {
          try {
            await db.saveProducts(products);
          } catch (error) {
            console.error('Error saving products to IndexedDB:', error);
            showToast('Error al guardar los productos', 'error');
          }
        };

        saveData();
      }, [products, isLoading]);

      // Efecto para guardar configuración en IndexedDB
      useEffect(() => {
        if (isLoading) return;
        
        const saveConfig = async () => {
          try {
            await db.saveConfig('darkMode', darkMode.toString());
          } catch (error) {
            console.error('Error saving dark mode to IndexedDB:', error);
          }
        };

        saveConfig();
        
        // Aplicar modo oscuro al body
        if (darkMode) {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
        }
      }, [darkMode, isLoading]);

      useEffect(() => {
        if (isLoading) return;
        
        const saveAlerts = async () => {
          try {
            await db.saveConfig('categoryAlerts', categoryAlerts);
          } catch (error) {
            console.error('Error saving alerts to IndexedDB:', error);
          }
        };

        saveAlerts();
      }, [categoryAlerts, isLoading]);

      // Función para obtener días restantes
      const getDaysRemaining = (expiryDate) => {
        const today = new Date();
        const expDate = new Date(expiryDate);
        const timeDiff = expDate - today;
        return Math.ceil(timeDiff / (1000 * 60 * 60 * 24));
      };

      // Función para determinar el estado del producto
      const getProductStatus = (expiryDate) => {
        const daysRemaining = getDaysRemaining(expiryDate);
        if (daysRemaining <= 0) return 'expired';
        if (daysRemaining <= 30) return 'warning';
        return 'fresh';
      };

      // Función para determinar la etapa de merma
      const getProductStage = (product) => {
        const daysRemaining = getDaysRemaining(product.expiryDate);
        const categoryCode = product.category.split(' ')[0];
        const alertDays = categoryAlerts[product.category] || 30;
        
        if (daysRemaining <= 0) return 'MERMA';
        if (daysRemaining <= Math.ceil(alertDays * 0.33)) return 'ETAPA 3';
        if (daysRemaining <= Math.ceil(alertDays * 0.66)) return 'ETAPA 2';
        if (daysRemaining <= alertDays) return 'ETAPA 1';
        return 'BUENO';
      };

      // Filtrar productos según búsqueda, categoría y pestaña activa
      const filteredProducts = useMemo(() => {
        return products.filter(product => {
          const matchesSearch = product.name.toLowerCase().includes(searchTerm.toLowerCase());
          const matchesCategory = filterCategory === '' || product.category === filterCategory;
          
          let matchesTab = true;
          if (activeTab === 'fresh') {
            matchesTab = getProductStatus(product.expiryDate) === 'fresh';
          } else if (activeTab === 'warning') {
            matchesTab = getProductStatus(product.expiryDate) === 'warning';
          } else if (activeTab === 'expired') {
            matchesTab = getProductStatus(product.expiryDate) === 'expired';
          }
          
          return matchesSearch && matchesCategory && matchesTab;
        });
      }, [products, searchTerm, filterCategory, activeTab]);

      // Calcular estadísticas
      const stats = useMemo(() => {
        const total = products.length;
        const fresh = products.filter(p => getProductStatus(p.expiryDate) === 'fresh').length;
        const warning = products.filter(p => getProductStatus(p.expiryDate) === 'warning').length;
        const expired = products.filter(p => getProductStatus(p.expiryDate) === 'expired').length;
        
        return { total, fresh, warning, expired };
      }, [products]);

      // Mostrar notificación
      const showNotification = (title, message) => {
        setNotification({ title, message });
        setTimeout(() => setNotification(null), 5000);
      };

      // Mostrar toast
      const showToast = (message, type = 'success') => {
        setToast({ message, type });
        setTimeout(() => setToast(null), 3000);
      };

      // Manejar agregar/editar producto
      const handleSaveProduct = (productData) => {
        if (currentProduct) {
          setProducts(prev => prev.map(p => p.id === currentProduct.id ? { ...productData, id: currentProduct.id } : p));
          showNotification('Producto actualizado', `${productData.name} ha sido actualizado`);
        } else {
          const newProduct = { ...productData, id: Date.now() };
          setProducts(prev => [...prev, newProduct]);
          showNotification('Producto agregado', `${productData.name} ha sido agregado`);
        }
        setShowModal(false);
        setCurrentProduct(null);
      };

      // Manejar eliminación
      const handleDeleteProduct = (product) => {
        if (window.confirm(`¿Está seguro de eliminar ${product.name}?`)) {
          setProducts(prev => prev.filter(p => p.id !== product.id));
          showNotification('Producto eliminado', `${product.name} ha sido eliminado`);
        }
      };

      // Manejar importación CSV
      const handleImportCSV = (event) => {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const text = e.target.result;
            const lines = text.split('\n').filter(line => line.trim());
            const imported = [];
            let errors = 0;

            for (let i = 1; i < lines.length; i++) { // Saltar encabezado
              const cols = lines[i].split(',').map(col => col.trim().replace(/^"(.*)"$/, '$1'));
              if (cols.length >= 5) {
                const [name, category, quantity, expiryDate, barcode] = cols;
                if (name && category && quantity && expiryDate) {
                  imported.push({
                    id: Date.now() + i,
                    name,
                    category,
                    quantity: parseInt(quantity) || 1,
                    expiryDate,
                    barcode: barcode || '',
                    image: ''
                  });
                } else {
                  errors++;
                }
              } else {
                errors++;
              }
            }

            setProducts(prev => [...prev, ...imported]);
            showNotification('Importación completada', `${imported.length} productos agregados, ${errors} errores`);
            setImportModal(false);
          } catch (error) {
            showNotification('Error', 'Error al procesar el archivo CSV');
          }
        };
        reader.readAsText(file);
        event.target.value = '';
      };

      // Exportar a CSV
      const exportToCSV = () => {
        if (products.length === 0) {
          showNotification('No hay productos', 'No hay productos para exportar');
          return;
        }
        try {
          // Crear contenido CSV
          const headers = ['Nombre', 'Categoría', 'Cantidad', 'Fecha de Vencimiento', 'Código de Barras'];
          let csvContent = headers.join(',') + '\n';
          
          products.forEach(product => {
            const row = [
              `"${product.name}"`,
              `"${product.category}"`,
              product.quantity,
              product.expiryDate,
              `"${product.barcode || ''}"`
            ].join(',');
            csvContent += row + '\n';
          });

          // Crear y descargar archivo
          const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
          const link = document.createElement('a');
          const url = URL.createObjectURL(blob);
          link.setAttribute('href', url);
          link.setAttribute('download', `inventario_${new Date().toISOString().split('T')[0]}.csv`);
          link.style.visibility = 'hidden';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          
          showNotification('Exportación exitosa', 'Productos exportados a CSV');
        } catch (error) {
          showNotification('Error', 'Error al exportar a CSV');
        }
      };

      // Generar PDF
      const generatePDF = () => {
        if (products.length === 0) {
          showNotification('No hay productos', 'No hay productos para exportar');
          return;
        }
        try {
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();
          
          // Título
          doc.setFontSize(18);
          doc.text('Inventario de Productos', 14, 22);
          
          // Fecha
          doc.setFontSize(11);
          doc.text(`Fecha: ${new Date().toLocaleDateString()}`, 14, 30);
          
          // Estadísticas
          const today = new Date();
          const expired = products.filter(p => getDaysRemaining(p.expiryDate) <= 0).length;
          const warning = products.filter(p => getDaysRemaining(p.expiryDate) <= 30 && getDaysRemaining(p.expiryDate) > 0).length;
          const fresh = products.length - expired - warning;
          
          doc.setFontSize(10);
          doc.text(`Total: ${products.length} productos`, 14, 40);
          doc.text(`En buen estado: ${fresh}`, 14, 45);
          doc.text(`Por vencer: ${warning}`, 14, 50);
          doc.text(`Vencidos: ${expired}`, 14, 55);
          
          // Encabezados de tabla
          const tableColumn = ["Código", "Nombre", "Ctg", "Cantidad", "Vencimiento", "Status", "Días", "Etapa"];
          const tableRows = [];
          
          for (const product of products) {
            const status = getProductStatus(product.expiryDate);
            const days = getDaysRemaining(product.expiryDate);
            const statusLabel = status === 'fresh' ? 'En buen estado' : status === 'warning' ? 'Por vencer' : 'Vencido';
            const code = product.category.split(' ')[0]; // Extraer código de categoría
            const stage = getProductStage(product);
            
            tableRows.push([
              code,
              product.name,
              product.category.substring(0, 10) + '...',
              product.quantity,
              new Date(product.expiryDate).toLocaleDateString(),
              statusLabel,
              days > 0 ? `${days} día${days !== 1 ? 's' : ''}` : days === 0 ? '¡Vence hoy!' : 'Vencido',
              stage
            ]);
          }
          
          // Crear tabla
          doc.autoTable({
            head: [tableColumn],
            body: tableRows,
            startY: 60,
            theme: 'striped',
            styles: { fontSize: 8 },
            headStyles: { fillColor: [79, 70, 229] }
          });
          
          // Guardar PDF
          doc.save(`inventario_${new Date().toISOString().split('T')[0]}.pdf`);
          showNotification('Exportación exitosa', 'Inventario exportado a PDF');
        } catch (error) {
          console.error('Error al exportar a PDF:', error);
          showNotification('Error', 'Error al exportar a PDF');
        }
      };

      // Iniciar escaneo de código de barras
      const startScanner = () => {
        setShowScanner(true);
        setTimeout(() => {
          if (Quagga) {
            Quagga.init({
              inputStream: {
                name: "Live",
                type: "LiveStream",
                target: videoRef.current,
                constraints: {
                  width: 640,
                  height: 480,
                  facingMode: "environment"
                },
              },
              decoder: {
                readers: [
                  "code_128_reader",
                  "ean_reader",
                  "ean_8_reader",
                  "code_39_reader",
                  "code_39_vin_reader",
                  "codabar_reader",
                  "upc_reader",
                  "upc_e_reader",
                  "i2of5_reader"
                ]
              }
            }, function(err) {
              if (err) {
                console.error(err);
                showNotification('Error', 'Error al iniciar la cámara');
                setShowScanner(false);
                return;
              }
              Quagga.start();
              Quagga.onDetected((data) => {
                setBarcodeResult(data.codeResult.code);
                Quagga.stop();
                setShowScanner(false);
              });
            });
          }
        }, 500);
      };

      // Detener escaneo
      const stopScanner = () => {
        if (Quagga) {
          Quagga.stop();
        }
        setShowScanner(false);
      };

      // Verificar productos próximos a vencer
      useEffect(() => {
        const checkExpiringProducts = () => {
          const today = new Date();
          const expiringProducts = [];
          
          products.forEach(product => {
            const expDate = new Date(product.expiryDate);
            const daysUntilExpiry = Math.ceil((expDate - today) / (1000 * 60 * 60 * 24));
            
            // Extrae solo el nombre de la categoría (después del primer espacio)
            const categoryParts = product.category.split(' ');
            const categoryName = categoryParts.slice(1).join(' ');
            
            // Verifica si está dentro del periodo de alerta
            const categoryCode = product.category.split(' ')[0];
            const alertDays = categoryAlerts[product.category] || 30;
            
            if (daysUntilExpiry <= alertDays && daysUntilExpiry > 0) {
              expiringProducts.push({
                name: product.name,
                days: daysUntilExpiry,
                category: categoryName
              });
            }
          });
          
          // Muestra notificación si hay productos próximos a vencer
          if (expiringProducts.length > 0) {
            const message = expiringProducts.slice(0, 3).map(p => `${p.name} (${p.days} días)`).join(', ');
            const remaining = expiringProducts.length - 3;
            const moreText = remaining > 0 ? ` y ${remaining} más` : '';
            showNotification('Productos por vencer', `Próximos a vencer: ${message}${moreText}`);
          }
        };
        
        checkExpiringProducts();
        const interval = setInterval(checkExpiringProducts, 86400000); // cada 24h
        
        return () => clearInterval(interval);
      }, [products, categoryAlerts]);

      // Componente de formulario
      const ProductForm = () => {
        const [formData, setFormData] = useState(
          currentProduct || {
            name: '',
            category: Object.keys(categoryAlerts)[0],
            quantity: 1,
            expiryDate: '',
            barcode: '',
            image: ''
          }
        );
        const [errors, setErrors] = useState({});
        const [scanning, setScanning] = useState(false);

        useEffect(() => {
          if (currentProduct) {
            setFormData(currentProduct);
          } else {
            setFormData({
              name: '',
              category: Object.keys(categoryAlerts)[0],
              quantity: 1,
              expiryDate: '',
              barcode: barcodeResult || '',
              image: ''
            });
          }
        }, [currentProduct, barcodeResult]);

        useEffect(() => {
          if (scanning && Quagga) {
            Quagga.init({
              inputStream: {
                name: "Live",
                type: "LiveStream",
                target: videoRef.current,
                constraints: {
                  width: 640,
                  height: 480,
                  facingMode: "environment"
                },
              },
              decoder: {
                readers: ["code_128_reader", "ean_reader", "ean_8_reader"]
              }
            }, function(err) {
              if (err) {
                console.error(err);
                setScanning(false);
                return;
              }
              Quagga.start();
              Quagga.onDetected((data) => {
                setFormData({...formData, barcode: data.codeResult.code});
                setScanning(false);
                Quagga.stop();
              });
            });
          }
          
          return () => {
            if (Quagga) {
              window.Quagga.offDetected();
            }
          };
        }, [scanning]);

        const handleChange = (e) => {
          const { name, value } = e.target;
          setFormData({
            ...formData,
            [name]: name === 'quantity' ? parseInt(value) || 1 : value
          });
          // Limpiar errores al cambiar
          if (errors[name]) {
            setErrors({ ...errors, [name]: '' });
          }
        };

        const handleImageChange = (e) => {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
              setFormData({...formData, image: e.target.result});
            };
            reader.readAsDataURL(file);
          }
        };

        const validateForm = () => {
          const newErrors = {};
          if (!formData.name.trim()) newErrors.name = 'El nombre es requerido';
          if (!formData.category) newErrors.category = 'La categoría es requerida';
          if (!formData.quantity || formData.quantity < 1) newErrors.quantity = 'La cantidad debe ser mayor a 0';
          if (!formData.expiryDate) newErrors.expiryDate = 'La fecha de vencimiento es requerida';
          
          setErrors(newErrors);
          return Object.keys(newErrors).length === 0;
        };

        const handleSubmit = (e) => {
          e.preventDefault();
          if (validateForm()) {
            handleSaveProduct(formData);
          }
        };

        return (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-20 modal fade-in">
            <div 
              className="bg-white dark:bg-gray-800 rounded-lg w-full max-w-md mx-4 slide-in flex flex-col"
              style={{maxHeight: '95vh', minHeight: '0'}}
            >
              <div className="overflow-y-auto flex-1" style={{ minHeight: 0, padding: '1.5rem' }}>
                <h2 className="text-2xl font-bold mb-4 text-gray-800 dark:text-white flex items-center">
                  <i className={`fas ${currentProduct ? 'fa-edit' : 'fa-plus'} mr-2`}></i>
                  {currentProduct ? 'Editar producto' : 'Agregar nuevo producto'}
                </h2>
                
                <form onSubmit={handleSubmit}>
                  <div className="mb-4">
                    <label className="block text-gray-700 dark:text-gray-300 mb-2">Nombre *</label>
                    <input
                      type="text"
                      name="name"
                      value={formData.name}
                      onChange={handleChange}
                      className={`w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white ${errors.name ? 'border-red-500' : 'border-gray-300 dark:border-gray-600'}`}
                      placeholder="Nombre del producto"
                    />
                    {errors.name && <p className="text-red-500 text-sm mt-1">{errors.name}</p>}
                  </div>
                  
                  <div className="mb-4">
                    <label className="block text-gray-700 dark:text-gray-300 mb-2">Categoría *</label>
                    <select
                      name="category"
                      value={formData.category}
                      onChange={handleChange}
                      className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                    >
                      {Object.keys(categoryAlerts).map(cat => (
                        <option key={cat} value={cat}>{cat}</option>
                      ))}
                    </select>
                    {errors.category && <p className="text-red-500 text-sm mt-1">{errors.category}</p>}
                  </div>
                  
                  <div className="mb-4">
                    <label className="block text-gray-700 dark:text-gray-300 mb-2">Cantidad *</label>
                    <input
                      type="number"
                      name="quantity"
                      value={formData.quantity}
                      onChange={handleChange}
                      min="1"
                      className={`w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white ${errors.quantity ? 'border-red-500' : 'border-gray-300 dark:border-gray-600'}`}
                    />
                    {errors.quantity && <p className="text-red-500 text-sm mt-1">{errors.quantity}</p>}
                  </div>
                  
                  <div className="mb-4">
                    <label className="block text-gray-700 dark:text-gray-300 mb-2">Fecha de Vencimiento *</label>
                    <input
                      type="date"
                      name="expiryDate"
                      value={formData.expiryDate}
                      onChange={handleChange}
                      className={`w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white ${errors.expiryDate ? 'border-red-500' : 'border-gray-300 dark:border-gray-600'}`}
                    />
                    {errors.expiryDate && <p className="text-red-500 text-sm mt-1">{errors.expiryDate}</p>}
                  </div>
                  
                  <div className="mb-4">
                    <label className="block text-gray-700 dark:text-gray-300 mb-2">Código de barras (opcional)</label>
                    <div className="flex">
                      <input
                        type="text"
                        name="barcode"
                        value={formData.barcode}
                        onChange={handleChange}
                        className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-l-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                        placeholder="Código de barras"
                      />
                      <button
                        type="button"
                        onClick={() => setScanning(true)}
                        className="bg-gray-200 dark:bg-gray-600 px-4 rounded-r-md hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors"
                        title="Escanear código de barras"
                      >
                        <i className="fas fa-barcode"></i>
                      </button>
                    </div>
                  </div>
                  
                  <div className="mb-4">
                    <label className="block text-gray-700 dark:text-gray-300 mb-2">Foto (opcional)</label>
                    <input
                      type="file"
                      accept="image/*"
                      onChange={handleImageChange}
                      className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                    />
                    {formData.image && (
                      <div className="mt-2">
                        <img src={formData.image} alt="Preview" className="h-20 object-cover rounded" />
                      </div>
                    )}
                  </div>
                  
                  <div className="flex space-x-3 pt-4">
                    <button
                      type="submit"
                      className="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-md transition-colors duration-200"
                    >
                      <i className="fas fa-save mr-2"></i>Guardar
                    </button>
                    <button
                      type="button"
                      onClick={() => { setShowModal(false); setCurrentProduct(null); }}
                      className="flex-1 bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-white py-2 px-4 rounded-md transition-colors duration-200"
                    >
                      <i className="fas fa-times mr-2"></i>Cancelar
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        );
      };

      // Componente de producto con imagen a la izquierda
      const ProductCard = ({ product }) => {
        const status = getProductStatus(product.expiryDate);
        const daysRemaining = getDaysRemaining(product.expiryDate);
        const stage = getProductStage(product);
        
        let statusClass = '';
        let statusLabel = '';
        let statusColor = '';
        
        switch(status) {
          case 'fresh':
            statusClass = 'status-fresh';
            statusLabel = 'En buen estado';
            statusColor = 'text-green-700';
            break;
          case 'warning':
            statusClass = 'status-warning';
            statusLabel = 'Por vencer';
            statusColor = 'text-yellow-700';
            break;
          case 'expired':
            statusClass = 'status-expired';
            statusLabel = 'Vencido';
            statusColor = 'text-red-700';
            break;
        }
        
        return (
          <div className="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 mb-3 border border-gray-200 dark:border-gray-700 hover:shadow-lg transition-shadow duration-200 product-card flex flex-col md:flex-row">
            {/* Imagen a la izquierda */}
            {product.image && (
              <div className="md:w-32 md:h-32 mb-4 md:mb-0 md:mr-4 flex-shrink-0">
                <img 
                  src={product.image} 
                  alt={product.name} 
                  className="w-full h-full object-cover rounded-lg border border-gray-200 dark:border-gray-700"
                />
              </div>
            )}
            
            {/* Datos a la derecha */}
            <div className="flex-1">
              <div className="flex justify-between items-start mb-2">
                <h3 className="font-semibold text-lg">{product.name}</h3>
                <span className={`px-2 py-1 rounded-full text-xs font-medium ${statusClass}`}>
                  {status === 'fresh' ? '✅' : status === 'warning' ? '⚠️' : '❌'} {statusLabel}
                </span>
              </div>
              
              <div className="grid grid-cols-2 gap-2 text-sm mb-3">
                <div><span className="font-medium">Categoría:</span> {product.category}</div>
                <div><span className="font-medium">Cantidad:</span> {product.quantity}</div>
                <div><span className="font-medium">Fecha:</span> {product.expiryDate}</div>
                <div><span className="font-medium">Etapa:</span> {stage}</div>
              </div>

              <div className="flex items-center mb-3">
                <i className={`fas fa-hourglass-half mr-2 ${statusColor}`}></i>
                <div>
                  <div className="font-medium">Días restantes</div>
                  <div className={statusColor}>
                    {daysRemaining > 0 
                      ? `${daysRemaining} día${daysRemaining !== 1 ? 's' : ''}` 
                      : daysRemaining === 0 
                        ? '¡Vence hoy!' 
                        : 'Vencido'}
                  </div>
                </div>
              </div>

              {product.barcode && (
                <div className="flex items-center mb-3">
                  <i className="fas fa-barcode mr-2 text-gray-500"></i>
                  <div>
                    <div className="font-medium">Código</div>
                    <div>{product.barcode}</div>
                  </div>
                </div>
              )}

              <div className="flex justify-end space-x-2">
                <button 
                  onClick={() => { setCurrentProduct(product); setShowModal(true); }}
                  className="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 text-sm"
                >
                  <i className="fas fa-edit mr-1"></i>Editar
                </button>
                <button 
                  onClick={() => handleDeleteProduct(product)}
                  className="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 text-sm"
                >
                  <i className="fas fa-trash mr-1"></i>Eliminar
                </button>
              </div>
            </div>
          </div>
        );
      };

      // Componente de configuración
      const SettingsModal = () => (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full max-h-screen overflow-y-auto">
            <div className="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700">
              <h2 className="text-xl font-semibold">Configuración de Alertas</h2>
              <button onClick={() => setShowSettings(false)} className="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                <i className="fas fa-times"></i>
              </button>
            </div>
            <div className="p-4">
              <div className="mb-4">
                <h3 className="font-medium mb-2">Días de alerta por categoría</h3>
                <p className="text-sm text-gray-600 dark:text-gray-400 mb-4">
                  Define cuántos días antes del vencimiento deseas ser notificado para cada categoría.
                </p>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 category-slider">
                  {Object.keys(categoryAlerts).map(category => (
                    <div key={category} className="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded">
                      <span className="text-sm">{category}</span>
                      <input
                        type="number"
                        value={categoryAlerts[category]}
                        onChange={(e) => setCategoryAlerts({
                          ...categoryAlerts,
                          [category]: parseInt(e.target.value) || 1
                        })}
                        className="w-20 px-2 py-1 border border-gray-300 dark:border-gray-600 rounded text-sm"
                        min="1"
                      />
                    </div>
                  ))}
                </div>
              </div>
              
              <div className="flex space-x-3 pt-6 border-t border-gray-200 dark:border-gray-700">
                <button
                  onClick={() => {
                    setCategoryAlerts(defaultCategoryAlerts);
                    showNotification('Valores restablecidos', 'Las alertas han sido restablecidas a sus valores predeterminados');
                  }}
                  className="px-4 py-2 bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-white rounded-md transition-colors duration-200"
                >
                  Restablecer
                </button>
                <button
                  onClick={() => setShowSettings(false)}
                  className="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-md transition-colors duration-200"
                >
                  Guardar cambios
                </button>
              </div>
            </div>
          </div>
        </div>
      );

      if (isLoading) {
        return (
          <div className="min-h-screen bg-gray-50 dark:bg-gray-900 flex items-center justify-center">
            <div className="text-center">
              <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
              <p className="text-gray-600 dark:text-gray-400">Cargando datos...</p>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-gray-50 dark:bg-gray-900 transition-colors duration-300">
          {/* Header */}
          <header className="bg-white dark:bg-gray-800 shadow-sm">
            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
              <div className="flex justify-between items-center py-4">
                <div className="flex items-center">
                  <i className="fas fa-calendar-check text-blue-600 dark:text-blue-400 text-2xl mr-2"></i>
                  <h1 className="text-2xl font-bold text-gray-900 dark:text-white">Control de Caducidades</h1>
                </div>
                <div className="flex items-center space-x-4">
                  {/* Modo oscuro/claro */}
                  <div className="flex items-center">
                    <span className="mr-2 text-sm">Modo</span>
                    <div className="relative inline-block w-10 align-middle select-none">
                      <input
                        type="checkbox"
                        name="dark-mode"
                        id="dark-mode"
                        checked={darkMode}
                        onChange={() => setDarkMode(!darkMode)}
                        className="toggle-checkbox hidden"
                      />
                      <label
                        htmlFor="dark-mode"
                        className="toggle-label block h-6 overflow-hidden w-11 rounded-full bg-gray-300 cursor-pointer"
                      >
                        <span className="block h-6 w-6 rounded-full bg-white shadow transform transition-transform duration-200 ease-in-out"></span>
                      </label>
                    </div>
                    <span className="ml-2 text-sm">
                      {darkMode ? 'Oscuro' : 'Claro'}
                    </span>
                  </div>
                  
                  {/* Configuración */}
                  <button
                    onClick={() => setShowSettings(true)}
                    className="p-2 rounded-full bg-blue-600 hover:bg-blue-700 text-white transition-colors duration-200"
                  >
                    <i className="fas fa-cog"></i>
                  </button>
                </div>
              </div>
            </div>
          </header>

          <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            {/* Estadísticas */}
            <div className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
              <div className="bg-white dark:bg-gray-800 rounded-lg shadow p-6 text-center stat-card">
                <div className="text-3xl font-bold text-blue-600 dark:text-blue-400">{stats.total}</div>
                <div className="text-gray-600 dark:text-gray-400">Total</div>
              </div>
              <div className="bg-white dark:bg-gray-800 rounded-lg shadow p-6 text-center stat-card">
                <div className="text-3xl font-bold text-green-600 dark:text-green-400">{stats.fresh}</div>
                <div className="text-gray-600 dark:text-gray-400">En buen estado</div>
              </div>
              <div className="bg-white dark:bg-gray-800 rounded-lg shadow p-6 text-center stat-card">
                <div className="text-3xl font-bold text-yellow-600 dark:text-yellow-400">{stats.warning}</div>
                <div className="text-gray-600 dark:text-gray-400">Por vencer</div>
              </div>
              <div className="bg-white dark:bg-gray-800 rounded-lg shadow p-6 text-center stat-card">
                <div className="text-3xl font-bold text-red-600 dark:text-red-400">{stats.expired}</div>
                <div className="text-gray-600 dark:text-gray-400">Vencidos</div>
              </div>
            </div>

            {/* Filtros y búsqueda */}
            <div className="bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-6">
              <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                  <label className="block text-sm font-medium mb-1">Buscar productos</label>
                  <input
                    type="text"
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                    placeholder="Buscar por nombre..."
                    className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium mb-1">Filtrar por categoría</label>
                  <select
                    value={filterCategory}
                    onChange={(e) => setFilterCategory(e.target.value)}
                    className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700"
                  >
                    <option value="">Todas las categorías</option>
                    {Object.keys(categoryAlerts).map(cat => (
                      <option key={cat} value={cat}>{cat}</option>
                    ))}
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium mb-1">Estado</label>
                  <select
                    value={activeTab}
                    onChange={(e) => setActiveTab(e.target.value)}
                    className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700"
                  >
                    <option value="all">Todos</option>
                    <option value="fresh">En buen estado</option>
                    <option value="warning">Por vencer</option>
                    <option value="expired">Vencidos</option>
                  </select>
                </div>
                <div className="flex items-end">
                  <button
                    onClick={() => setShowModal(true)}
                    className="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-md transition-colors duration-200 flex items-center justify-center"
                  >
                    <i className="fas fa-plus mr-2"></i> Agregar producto
                  </button>
                </div>
              </div>
            </div>

            {/* Lista de productos */}
            <div className="bg-white dark:bg-gray-800 rounded-lg shadow">
              {filteredProducts.length === 0 ? (
                <div className="p-12 text-center text-gray-500 dark:text-gray-400">
                  <i className="fas fa-box-open text-4xl mb-4 opacity-50"></i>
                  <h3 className="text-lg font-medium mb-2">No hay productos</h3>
                  <p className="mb-4">No se encontraron productos que coincidan con los filtros.</p>
                  <button
                    onClick={() => setShowModal(true)}
                    className="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300"
                  >
                    Agregar un producto
                  </button>
                </div>
              ) : (
                <div className="p-6 max-h-96 overflow-y-auto scrollbar-custom">
                  {filteredProducts.map(product => (
                    <ProductCard key={product.id} product={product} />
                  ))}
                </div>
              )}
            </div>
          </main>

          {/* Botón flotante */}
          <button
            onClick={() => setShowModal(true)}
            className="fixed bottom-6 right-6 floating-button"
          >
            <i className="fas fa-plus text-xl"></i>
          </button>

          {/* Modal de producto */}
          {showModal && <ProductForm />}

          {/* Modal de configuración */}
          {showSettings && <SettingsModal />}

          {/* Modal de escáner */}
          {showScanner && (
            <div className="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center p-4 z-50">
              <div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full">
                <div className="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700">
                  <h2 className="text-xl font-semibold">Escanear Código de Barras</h2>
                  <button onClick={stopScanner} className="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i className="fas fa-times"></i>
                  </button>
                </div>
                <div className="p-4">
                  <video ref={videoRef} className="w-full rounded" autoPlay playsInline></video>
                  {barcodeResult && (
                    <div className="mt-4 p-3 bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 rounded">
                      Código detectado: <strong>{barcodeResult}</strong>
                    </div>
                  )}
                </div>
              </div>
            </div>
          )}

          {/* Notificación */}
          {notification && (
            <div className="notification">
              <div className="font-semibold">{notification.title}</div>
              <div className="text-sm opacity-90">{notification.message}</div>
            </div>
          )}
        </div>
      );
    };

    // Renderizar la app
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
